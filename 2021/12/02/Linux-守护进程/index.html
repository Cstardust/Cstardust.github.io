<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Linux守护进程">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux-守护进程">
<meta property="og:url" content="http://example.com/2021/12/02/Linux-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/index.html">
<meta property="og:site_name" content="不落辰">
<meta property="og:description" content="Linux守护进程">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2021/12/02/Linux-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/2021-12-02-14-09-28.png">
<meta property="og:image" content="http://example.com/2021/12/02/Linux-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/2021-12-02-14-31-39.png">
<meta property="article:published_time" content="2021-12-02T00:51:46.000Z">
<meta property="article:modified_time" content="2022-05-28T14:19:00.255Z">
<meta property="article:author" content="Cstardust">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/12/02/Linux-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/2021-12-02-14-09-28.png">

<link rel="canonical" href="http://example.com/2021/12/02/Linux-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Linux-守护进程 | 不落辰</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="不落辰" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">不落辰</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">知不可乎骤得,托遗响于悲风</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/02/Linux-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cstardust">
      <meta itemprop="description" content="知不可乎骤得,托遗响于悲风">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不落辰">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux-守护进程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-02 08:51:46" itemprop="dateCreated datePublished" datetime="2021-12-02T08:51:46+08:00">2021-12-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-28 22:19:00" itemprop="dateModified" datetime="2022-05-28T22:19:00+08:00">2022-05-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Linux守护进程</p>
<span id="more"></span>

<ul>
<li>参考APUE、<a target="_blank" rel="noopener" href="https://www.cnblogs.com/ybf-yyj/p/9104412.html">博客园</a></li>
</ul>
<h2 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h2><ul>
<li>&amp;<ul>
<li><code>./a.out &amp;</code> ：释放对终端的占用。在后台运行</li>
</ul>
</li>
<li>jobs<ul>
<li>列出在后台运行的进程：<code>running stopped terminated</code>。jobs -l可以列出pid</li>
</ul>
</li>
<li>ctrl + z  挂起<ul>
<li>用户终端向正在运行中的由该终端启动的程序发出SIGTSTP信号。默认动作为暂停进程（并未结束）。并将该进程放到后台。（停止终端交互进程的运行。）</li>
</ul>
</li>
<li>bg<ul>
<li>启动在后台暂停的进程，并使得其在后台运行。</li>
<li>如果后台中有多个命令，可以用bg %jobnumber将选中的命令调出，%jobnumber是通过jobs命令查到的后台正在执行的命令的序号(不是pid)</li>
<li>将任务转移到后台运行：先ctrl + z；再bg，这样进程就被移到后台运行，终端还能继续接受命令。</li>
</ul>
</li>
<li>fg<ul>
<li><code>fg %jobnum</code>将在后台暂停/运行的进程，调到前台来，使其占据终端。</li>
</ul>
</li>
<li>ctrl + c 终止<ul>
<li>用户终端向正在运行中的由该终端启动的程序发出SIGINT信号。默认动作为终止进程。</li>
</ul>
</li>
<li>ctrl + \ 退出<ul>
<li>用户终端向正在运行中的由该终端启动的程序发出SIGQUIT。默认动作为终止进程。</li>
</ul>
</li>
<li>ctrl + d<ul>
<li>输入文件结束符EOF</li>
</ul>
</li>
<li>pstree<ul>
<li>查看进程树</li>
</ul>
</li>
<li>概念：当前任务<ul>
<li>如果后台的任务号有2个，[1],[2]；如果当第一个后台任务顺利执行完毕，第二个后台任务还在执行中时，当前任务便会自动变成后台任务号码“[2]” 的后台任务。所以可以得出一点，即当前任务是会变动的。当用户输入“fg”、“bg”和“stop”等命令时，如果不加任何引号，则所变动的均是当前任务</li>
</ul>
</li>
<li>参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/ybf-yyj/p/9104412.html">博客园</a></li>
</ul>
<h2 id="进程组与会话"><a href="#进程组与会话" class="headerlink" title="进程组与会话"></a>进程组与会话</h2><ul>
<li>进程组是一堆相关进程的集合；会话是一堆相关进程组的集合。</li>
</ul>
<h2 id="进程组"><a href="#进程组" class="headerlink" title="进程组"></a>进程组</h2><ul>
<li>进程组是一个或者多个进程的集合。通常他们在同一作业中结合起来。</li>
<li>同一进程组的各进程接收来自同一终端的各种信号。每个进程组有唯一的进程组ID。函数<code>pid_t getpgrp(void);</code>可以返回调用进程的进程组ID。</li>
<li>每个进程组有一个组长进程。<strong>进程组ID等于其组长进程的进程ID</strong></li>
<li>进程组组长可以创建一个进程组、创建该组中的进程，然后终止。只要进程组中有一个进程存在，那么这个进程组就存在，与组长进程是否终止无关。</li>
<li>进程调用setpgid可以加入一个现有的进程组或者创建一个新进程组。<ul>
<li><code>int setpgid(pid_t pid,pid_t pgid)</code></li>
<li>该函数将pid进程的进程组号设置为pgid，如果pid=pgid，则该pid进程成为组长进程。如果pid=0，即为getpid()；pgid=0，即为pid作为进程组pgid。</li>
<li>成功0，失败-1。</li>
</ul>
</li>
<li>一个进程只能为他或者他的子进程设置组进程pgid。在它的子进程调用exec后，他就不再更改子进程的进程组ID<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">shc@shc-<span class="keyword">virtual</span>-machine:~/code/revier/src$ ps ajx</span><br><span class="line">  PPID    PID   PGID    SID TTY       TPGID STAT   UID   TIME COMMAND</span><br><span class="line">     <span class="number">0</span>      <span class="number">1</span>      <span class="number">1</span>      <span class="number">1</span> ?            <span class="number">-1</span> Ss       <span class="number">0</span>   <span class="number">0</span>:<span class="number">03</span> /sbin/init splash</span><br><span class="line"></span><br><span class="line">PPID：是当前进程的父进程号。</span><br><span class="line"></span><br><span class="line">PID：进程的唯一标识。如果一个进程含有多个线程，所有线程调用 getpid 函数会返回相同的值。</span><br><span class="line"></span><br><span class="line">PGID：进程组 ID。每个进程都会有进程组 ID，表示该进程所属的进程组。默认情况下新创建的进程会继承父进程的进程组 ID。</span><br><span class="line"></span><br><span class="line">SID：会话 ID。每个进程也都有会话 ID。默认情况下，新创建的进程会继承父进程的会话 ID。</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h2><ul>
<li>会话是一个或者多个进程组的集合。<br><img src="/2021/12/02/Linux-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/2021-12-02-14-09-28.png"></li>
<li><code>pid_t setsid(void);</code><ul>
<li>如果调用此函数的进程不是一个进程组组长，那么此函数创建一个新会话。<ul>
<li>该进程会变成新会话的会话首进程（会话首进程是创建该会话的进程）。此时，该进程是新会话中的唯一进程。</li>
<li>该进程成为一个新进程组的组长进程。新进程组ID是该调用进程的进程ID</li>
<li>该进程没有控制终端。如果在调用setsid之前该进程有一个控制终端，那么这种联系也被切断。<ul>
<li>即会话首进程不占有控制终端。只有会话中的前台进程组才占有终端。！</li>
</ul>
</li>
</ul>
</li>
<li>如果该调用进程是一个进程组组长，则此函数返回出错。</li>
<li>所以通常先fork，使其父进程终止，而子进程继续，因为子进程继承父进程的进程组ID，而其进程ID是新分配的，两者不可能相等，这就保证了子进程不是一个进程组组长。</li>
</ul>
</li>
<li>Single UNIX 没有类似于进程组ID的会话ID，由于会话首进程是具有唯一进程ID的单个进程，所以可以将会话首进程的进程ID视为会话ID。</li>
<li>SVR4引入会话ID。<ul>
<li><code>pid_t getsid(pid_t pid);</code></li>
<li>返回pid进程的会话首进程的进程组ID。pid=0，则返回调用进程的。</li>
<li>若pid不属于调用者所在会话，那么就不能得到会话ID。</li>
</ul>
</li>
<li>尽量避免使用“会话ID”，而是称其为“会话首进程的进程组ID”。会话首进程总是一个进程组的组长进程，所以两者等价。</li>
</ul>
<h2 id="控制终端"><a href="#控制终端" class="headerlink" title="控制终端"></a>控制终端</h2><ul>
<li>一般情况下 session 和终端是一对一的关系，当我们打开多个终端窗口时，实际上就创建了多个 session。</li>
<li><code>./a.out &amp;</code>。表示将命令放入后台执行。这样该命令对应的进程组即为后台进程组。</li>
<li>shell 中可以存在多个进程组，无论是前台进程组还是后台进程组，它们或多或少存在一定的联系，为了更好地控制这些进程组（或者称为作业），系统引入了会话的概念。</li>
<li><strong>会话（Session）的意义在于将很多的工作集中在一个终端，选取其中一个作为前台来直接接收终端的输入及信号，其他的工作则放在后台执行。</strong></li>
<li>以上几点参考<a target="_blank" rel="noopener" href="https://rongweihe.github.io/">博客.io</a><br><img src="/2021/12/02/Linux-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/2021-12-02-14-31-39.png"></li>
<li>一个会话可以有一个控制终端（ controlling terminal）。这通常是我们在其上登录的终端设备（终端登录情况）或伪终端设备（网络登录情况）。</li>
<li>建立与控制终端连接的会话首进程，被称之为控制进程（controlling process）。</li>
<li><strong>一个会话的几个进程组可被分成一个前台进程组（foreground process group）以及一个或几个后台进程组（background process group）。</strong><ul>
<li>在任意时刻，可能同时存在多个后台进程组，但是不管什么时候都只能有一个前台进程组。</li>
</ul>
</li>
<li>如果一个会话有一个控制终端，则它有一个前台进程组，其他进程组则为后台进程组。</li>
<li>无论何时键入中断键（常常是DELETE或Ctrl - C）或退出键（常常是Ctrl - \），就会造成将中断信号或退出信号<strong>送至前台进程组的所有进程。</strong><ul>
<li><strong>只有在前台进程组中进程才能在控制终端读取输入</strong>。当用户在终端输入信号生成终端字符（如 ctrl+c、ctrl+z、ctr+\等）时，对应的信号只会发送给前台进程组。从前台进程组的输出也会显示在控制终端上。</li>
</ul>
</li>
<li>如果终端界面检测到调制解调器已经脱开连接，则将挂断信号送至控制进程（会话首进程。）</li>
</ul>
<h2 id="作业控制"><a href="#作业控制" class="headerlink" title="作业控制"></a>作业控制</h2><ul>
<li>作业：几个进程的集合，通常是一个进程管道<ul>
<li><code>vim main.c</code><ul>
<li>在前台起到了只有一个进程组成的作业。</li>
</ul>
</li>
<li><code>pr *.c | lpr &amp;       。      make all &amp;</code><ul>
<li>在后台启动两个作业。后台运行。</li>
<li>使用管道，让多个进程互相配合完成一项工作，这一组进程属于同一个进程组</li>
</ul>
</li>
</ul>
</li>
<li>以后补充。</li>
</ul>
<h2 id="守护（daemon）进程"><a href="#守护（daemon）进程" class="headerlink" title="守护（daemon）进程"></a>守护（daemon）进程</h2><ul>
<li>系统引导装入时启动，系统关闭时终止。</li>
<li>由于无控制终端，所以说是在后台运行的。</li>
</ul>
<ul>
<li>创建守护进程<ul>
<li>关键<ul>
<li>创建会话Session</li>
</ul>
</li>
<li>流程<ul>
<li>fork之后，父进程exit。<ul>
<li>进程组组长不能创建会话</li>
</ul>
</li>
<li>setsid子进程创建会话。<ul>
<li><code>pid_t setsid()</code></li>
<li>子进程成为新的会话的首进程</li>
<li>子进程成为一个新进程组的组长</li>
<li>子进程脱离控制终端，在后台运行</li>
</ul>
</li>
<li>chdir更改工作目录<ul>
<li><code>int chdir(const char *path);</code></li>
<li>root用户才有权限</li>
</ul>
</li>
<li>umask设置文件权限掩码<ul>
<li><code>mode_t umask(mode_t mask);</code></li>
<li>将文件模式创建屏蔽字设置为一个已知值。（通常为0）。由继承得来的文件模式创建屏蔽字可能会被设置为拒绝某些权限。</li>
</ul>
</li>
<li>关闭非必要文件描述符<ul>
<li>继承的打开文件不会用到，浪费系统资源，无法卸载</li>
</ul>
</li>
<li>某些进程打开/dev/null 赋值给 stdin ，stdout ，stderr。<ul>
<li><blockquote>
<p>任何一个试图读取标准输入、写标准输出或标准错误的库例程都不会产生任何效果。因为守护进程不予终端设备相关联，所以其输出无处显示，也无处从交互式用户那里接收输入。</p>
</blockquote>
</li>
<li><blockquote>
<p>即使守护进程是从交互式会话启动的，但是守护进程是在后台运行的，所以登录会话的终止不会影响守护进程。如果其他用户在同一终端设备上登录，我们不希望再该终端上见到守护进程的输出，用户也不期望他们在终端上的输入被守护进程读取。</p>
</blockquote>
</li>
<li><blockquote>
<p>APUE</p>
</blockquote>
</li>
</ul>
</li>
<li>开始执行守护进程核心工作守护进程退出处理程序模型</li>
</ul>
</li>
</ul>
</li>
<li><strong>问题？</strong><ul>
<li>守护进程处理SIGCHLD信号。</li>
<li><blockquote>
<p>处理SIGCHLD信号<br>处理SIGCHLD信号并不是必须的。但对于某些进程，特别是服务器进程往往在请求到来时生成子进程处理请求。如果<strong>父进程不对残留信息进行处理</strong>，子进程将成为僵尸进程（zombie）从而占用系统资源。如果父进程wait子进程结束，将增加父进程的负担，影响服务器进程的并发性能。在Linux下可以简单地将SIGCHLD信号的操作设为SIG_IGN。</p>
</blockquote>
</li>
<li><code>signal(SIGCHLD,SIG_IGN);</code></li>
<li>SIG_IGN即我们不关心这个信号，系统也就懂了我们不关心它的死法。子进程死亡的话则直接释放资源即可。没死的话，也是忽略。</li>
<li>详情见进程–<code>wait</code>和信号–<code>SIGCHLD</code></li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(str);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//  1. fork，父进程exit。（为了创建会话）</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid&gt;<span class="number">0</span>)   <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//  2. setsid()创建会话。当前子进程成为会话首进程，接着成为新进程族的组长进程，并且没有控制终端</span></span><br><span class="line">    <span class="comment">//  为了满足dameon的”在后台运行” 。（由于会话首进程无控制终端，所以说是在后台运行的。）</span></span><br><span class="line">    pid = setsid();</span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">-1</span>) </span><br><span class="line">        sys_err(<span class="string">&quot;pid error&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//  3. 改变工作目录。防止被卸载。</span></span><br><span class="line">    <span class="comment">//  为了满足daemon进程的“系统引导装入时启动，系统关闭时终止。”</span></span><br><span class="line">    <span class="comment">//  sudo 只有根目录才有权限切换</span></span><br><span class="line">    <span class="comment">//  并且我实验当前虚拟机关机重启之后那个dameon进程就没了</span></span><br><span class="line">    <span class="comment">//  感觉因为守护进程在系统引导装入时启动，系统关闭时终止。</span></span><br><span class="line">    <span class="comment">//  而如果是一个用户远程登陆linux系统的话，那么这个用户退出登陆之后，不会影响这个daemon进程</span></span><br><span class="line">    <span class="keyword">int</span> ret = chdir(<span class="string">&quot;/root&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)</span><br><span class="line">       sys_err(<span class="string">&quot;chdir error&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  4.  改变权限</span></span><br><span class="line">    umask(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  5.  关闭文件描述符</span></span><br><span class="line">    close(STDIN_FILENO);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  6.  打开null，重定向文件描述符号</span></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/dev/null&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd==<span class="number">-1</span>)</span><br><span class="line">        sys_err(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">    dup2(fd,STDOUT_FILENO);</span><br><span class="line">    dup2(fd,STDERR_FILENO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);   <span class="comment">//  模拟守护进程业务</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">shc@shc-<span class="keyword">virtual</span>-machine:~/code/revier/src$ sudo ./daemon_shc.out </span><br><span class="line">[sudo] shc 的密码： </span><br><span class="line">shc@shc-<span class="keyword">virtual</span>-machine:~/code/revier/src$ ps ajx</span><br><span class="line">  <span class="number">1624</span>   <span class="number">2730</span>   <span class="number">2730</span>   <span class="number">2730</span> ?            <span class="number">-1</span> Rs       <span class="number">0</span>   <span class="number">0</span>:<span class="number">20</span> ./daemon_shc.out</span><br></pre></td></tr></table></figure>

<h2 id="manpage阅读"><a href="#manpage阅读" class="headerlink" title="manpage阅读"></a>manpage阅读</h2><ul>
<li>umask<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       <span class="built_in">umask</span> - <span class="built_in">set</span> file mode creation mask</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       <span class="comment">#include &lt;sys/types.h&gt;</span></span><br><span class="line">       <span class="comment">#include &lt;sys/stat.h&gt;</span></span><br><span class="line"></span><br><span class="line">       mode_t <span class="built_in">umask</span>(mode_t mask);</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">       <span class="built_in">umask</span>() sets the calling process<span class="string">&#x27;s file mode creation mask (umask) to mask &amp; 0777 (i.e., only the file permission bits of mask are used), and returns the previous value of the mask.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       The  umask  is  used  by  open(2), mkdir(2), and other system calls that create files to modify the permissions placed on newly created files or directories.  Specifically, permissions in the</span></span><br><span class="line"><span class="string">       umask are turned off from the mode argument to open(2) and mkdir(2).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       Alternatively, if the parent directory has a default ACL (see acl(5)), the umask is ignored, the default ACL is inherited, the permission bits are set based on the inherited ACL, and  permis‐</span></span><br><span class="line"><span class="string">       sion bits absent in the mode argument are turned off.  For example, the following default ACL is equivalent to a umask of 022:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           u::rwx,g::r-x,o::r-x</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       Combining the effect of this default ACL with a mode argument of 0666 (rw-rw-rw-), the resulting file permissions would be 0644 (rw-r--r--).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       The constants that should be used to specify mask are described in inode(7).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       The typical default value for the process umask is S_IWGRP | S_IWOTH (octal 022).  In the usual case where the mode argument to open(2) is specified as:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       (octal 0666) when creating a new file, the permissions on the resulting file will be:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       (because 0666 &amp; ~022 = 0644; i.e., rw-r--r--).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RETURN VALUE</span></span><br><span class="line"><span class="string">       This system call always succeeds and the previous value of the mask is returned.</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="进程补充"><a href="#进程补充" class="headerlink" title="进程补充"></a>进程补充</h2><ul>
<li>进程是系统分配资源的最小单位。</li>
<li><code>pstree</code>查看进程家族树<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">systemd─┬─ModemManager───2*[&#123;ModemManager&#125;]</span><br><span class="line">        ├─NetworkManager─┬─dhclient</span><br><span class="line">        │                └─2*[&#123;NetworkManager&#125;]</span><br><span class="line">        ├─VGAuthService</span><br><span class="line">        ├─accounts-daemon───2*[&#123;accounts-daemon&#125;]</span><br><span class="line">        ├─acpid</span><br><span class="line">        ├─cupsd</span><br><span class="line">        ├─dbus-daemon</span><br><span class="line">        ├─fwupd───4*[&#123;fwupd&#125;]</span><br><span class="line">        ├─gdm3─┬─gdm-session-wor─┬─gdm-wayland-ses─┬─gnome-session-b─┬─gnome-shell─┬─Xwayland───8*[&#123;Xwayland&#125;]</span><br><span class="line">        │      │                 │                 │                 │             ├─ibus-daemon─┬─ibus-dconf───3*[&#123;ibus-dconf&#125;]</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/11/30/Linux-%E4%BF%A1%E5%8F%B7/" rel="prev" title="Linux-信号">
      <i class="fa fa-chevron-left"></i> Linux-信号
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/12/03/Linux-%E7%BA%BF%E7%A8%8B/" rel="next" title="Linux-线程">
      Linux-线程 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="nav-number">1.</span> <span class="nav-text">相关命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%84%E4%B8%8E%E4%BC%9A%E8%AF%9D"><span class="nav-number">2.</span> <span class="nav-text">进程组与会话</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%84"><span class="nav-number">3.</span> <span class="nav-text">进程组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D"><span class="nav-number">4.</span> <span class="nav-text">会话</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E7%BB%88%E7%AB%AF"><span class="nav-number">5.</span> <span class="nav-text">控制终端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%9C%E4%B8%9A%E6%8E%A7%E5%88%B6"><span class="nav-number">6.</span> <span class="nav-text">作业控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%88%E6%8A%A4%EF%BC%88daemon%EF%BC%89%E8%BF%9B%E7%A8%8B"><span class="nav-number">7.</span> <span class="nav-text">守护（daemon）进程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#manpage%E9%98%85%E8%AF%BB"><span class="nav-number">8.</span> <span class="nav-text">manpage阅读</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E8%A1%A5%E5%85%85"><span class="nav-number">9.</span> <span class="nav-text">进程补充</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Cstardust</p>
  <div class="site-description" itemprop="description">知不可乎骤得,托遗响于悲风</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cstardust</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">564k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">8:33</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'd683461326668b112a07',
      clientSecret: 'fbd3f91ac2d4f7b501c4b5f88af770661529c238',
      repo        : 'BlogComments',
      owner       : 'Cstardust',
      admin       : ['Cstardust'],
      id          : '4264f7acafac54e679e3b3560fb31ac7',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
