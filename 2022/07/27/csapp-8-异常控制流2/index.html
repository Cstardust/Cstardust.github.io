<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="信号 signal信号编号、事件、默认行为、处理方式（见Linux信号）发送信号方式、接收信号阻塞、接触阻塞信号进程接收信号流程  内核为每个进程维护了pending和blocked  非本地跳转catch – setjmp、throw – longjmp">
<meta property="og:type" content="article">
<meta property="og:title" content="csapp-8-异常控制流2">
<meta property="og:url" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/index.html">
<meta property="og:site_name" content="不落辰">
<meta property="og:description" content="信号 signal信号编号、事件、默认行为、处理方式（见Linux信号）发送信号方式、接收信号阻塞、接触阻塞信号进程接收信号流程  内核为每个进程维护了pending和blocked  非本地跳转catch – setjmp、throw – longjmp">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-13-59-40.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-14-32-28.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-15-38-18.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-20-04-31.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-20-09-06.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-20-09-18.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-13-52-44.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-13-50-02.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-14-37-43.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-14-38-08.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-14-49-31.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-15-11-50.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-15-12-03.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-15-33-49.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-15-38-34.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-12-18-38-49.png">
<meta property="og:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-12-18-43-14.png">
<meta property="article:published_time" content="2022-07-27T01:31:39.000Z">
<meta property="article:modified_time" content="2023-02-27T15:18:17.802Z">
<meta property="article:author" content="Cstardust">
<meta property="article:tag" content="CSAPP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-13-59-40.png">

<link rel="canonical" href="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>csapp-8-异常控制流2 | 不落辰</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="不落辰" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">不落辰</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">知不可乎骤得,托遗响于悲风</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cstardust">
      <meta itemprop="description" content="知不可乎骤得,托遗响于悲风">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不落辰">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          csapp-8-异常控制流2
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-27 09:31:39" itemprop="dateCreated datePublished" datetime="2022-07-27T09:31:39+08:00">2022-07-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-27 23:18:17" itemprop="dateModified" datetime="2023-02-27T23:18:17+08:00">2023-02-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSAPP/" itemprop="url" rel="index"><span itemprop="name">CSAPP</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>15 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li><p>信号 signal<br>信号编号、事件、默认行为、处理方式（见Linux信号）<br>发送信号方式、接收信号<br>阻塞、接触阻塞信号<br>进程接收信号流程<br>  内核为每个进程维护了pending和blocked</p>
</li>
<li><p>非本地跳转<br>catch – setjmp、throw – longjmp</p>
</li>
</ul>
<span id="more"></span>

<h2 id="Signal-信号"><a href="#Signal-信号" class="headerlink" title="Signal 信号"></a>Signal 信号</h2><ul>
<li>Linux信号：更高层次，软件形式的异常。它允许进程和内核中断其他进程。</li>
<li>定义：一个<strong>信号</strong>就是一条小消息，它通知进程系统中发生了一个某种类型的事件。<ul>
<li>信号由内核（可能是应另一个进程的要求）发送给一个进程。    </li>
<li>信号提供了一种机制，通知用户进程发生了什么类型的异常。</li>
</ul>
</li>
<li><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-13-59-40.png"></li>
</ul>
<ul>
<li><strong>fork出的子进程会继承父进程关于signal的dispostion 如处理函数、掩码等</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A  child created via fork(2) inherits a copy of its parent<span class="string">&#x27;s signal dispositions.  During an execve(2), the dispositions of handled signals are reset to the default; the</span></span><br><span class="line"><span class="string">dispositions of ignored signals are left unchanged.</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="信号的两个阶段"><a href="#信号的两个阶段" class="headerlink" title="信号的两个阶段"></a>信号的两个阶段</h3><p>以下仅为方便自己理解</p>
<ul>
<li>被处理的信号：<strong>信号被接收</strong></li>
<li>发出但还没被处理的信号：<strong>待处理信号</strong></li>
</ul>
<p>待处理信号集 / 未决信号集：1表示待处理，即内核发送了，但该信号还没被进程接收(处理)。</p>
<p>阻塞/屏蔽信号集：1表示该信号目前不可被prog进程接收(处理)。<br>一般是因为该信号在被进程的处理程序处理，此时，若内核再发送一个该信号SIGINT，则将该信号加入待处理信号集(置1)，待处理信号集不可排队（只是二进制而已）；即有多个该信号发送来，也只能有一个被加入待处理信号集，其余被抛弃。</p>
<h3 id="传送信号的步骤"><a href="#传送信号的步骤" class="headerlink" title="传送信号的步骤"></a>传送信号的步骤</h3><ul>
<li><p>kernal -&gt; process</p>
<h4 id="发送信号"><a href="#发送信号" class="headerlink" title="发送信号"></a>发送信号</h4></li>
<li><p>如何<strong>递送</strong>信号：</p>
<ul>
<li>内核通过更新目的进程上下文中的某个状态，发送（<strong>递送</strong>）一个信号给目的进程</li>
</ul>
</li>
<li><p>发送信号原因</p>
<ul>
<li>内核检测到一个系统事件，比如除0错误或者子进程错误</li>
<li>一个进程调用了kill函数，显示地要求内核发送一个信号给目的进程，一个进程可以放信号给它自己。</li>
</ul>
</li>
<li><p>一个进程可以发送信号给他自己</p>
</li>
</ul>
<h4 id="接收信号"><a href="#接收信号" class="headerlink" title="接收信号"></a>接收信号</h4><ul>
<li><strong>接收</strong>信号<ul>
<li>当目的进程被内核强迫以某种方式对信号的发送做出反应时，他就接收了信号。</li>
<li>进程对信号的反应<ul>
<li><strong>忽略</strong> Ignore the    signal    (do    nothing)</li>
<li><strong>终止</strong> Terminate    the    process    (with optional    core    dump)</li>
<li><strong>信号处理程序</strong> Catch the    signal    by    executing    a user-level function called signal    handler。<ul>
<li>具体信号处理程序的默认行为都是什么。下文有接收信号有。</li>
<li> Akin    to    a    hardware    exception    handler    being called in    response to    an    asynchronous interrupt<br><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-14-32-28.png"></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Signal dispositions</span><br><span class="line">    Each signal has a current disposition, <span class="built_in">which</span> determines how the process behaves when it is delivered the signal.</span><br><span class="line"></span><br><span class="line">    The entries <span class="keyword">in</span> the <span class="string">&quot;Action&quot;</span> column of the tables below specify the default disposition <span class="keyword">for</span> each signal, as follows:</span><br><span class="line"></span><br><span class="line">    Term   Default action is to terminate the process.</span><br><span class="line"></span><br><span class="line">    Ign    Default action is to ignore the signal.</span><br><span class="line"></span><br><span class="line">    Core   Default action is to terminate the process and dump core (see core(5)).</span><br><span class="line"></span><br><span class="line">    Stop   Default action is to stop the process.</span><br><span class="line"></span><br><span class="line">    Cont   Default action is to <span class="built_in">continue</span> the process <span class="keyword">if</span> it is currently stopped.</span><br></pre></td></tr></table></figure>


<h3 id="send-signal-发送信号"><a href="#send-signal-发送信号" class="headerlink" title="send signal 发送信号"></a>send signal 发送信号</h3><h4 id="进程组-amp-会话session"><a href="#进程组-amp-会话session" class="headerlink" title="进程组 &amp; 会话session"></a>进程组 &amp; 会话session</h4><p><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-15-38-18.png"></p>
<ul>
<li>作业job：对一条命令求值而创建的进程。</li>
<li>每个进程只属于一个进程组</li>
<li>进程组是一个或者多个进程的集合</li>
<li>会话session 是一个或者多个进程组的集合。</li>
<li>一般情况下 session 和终端是一对一的关系，当我们打开多个终端窗口时，实际上就创建了多个 session。</li>
<li><code>./a.out &amp;</code>。表示将命令放入后台执行。这样该命令对应的进程组即为后台进程组。</li>
<li>shell 中可以存在多个进程组，无论是前台进程组还是后台进程组，它们或多或少存在一定的联系，为了更好地控制这些进程组（或者称为作业），系统引入了会话的概念。</li>
<li><strong>会话（Session）的意义在于将很多的工作集中在一个终端，选取其中一个作为前台来直接接收终端的输入及信号，其他的工作则放在后台执行。</strong></li>
<li><strong>一个会话的几个进程组可被分成一个前台进程组（foreground process group）以及一个或几个后台进程组（background process group）。</strong><ul>
<li>在任意时刻，可能同时存在多个后台进程组，但是不管什么时候都只能有一个前台进程组。</li>
<li>如果一个会话有一个控制终端，则它有一个前台进程组，其他进程组则为后台进程组。</li>
</ul>
</li>
</ul>
<h4 id="从键盘发送信号"><a href="#从键盘发送信号" class="headerlink" title="从键盘发送信号"></a>从键盘发送信号</h4><ul>
<li>无论何时键入中断键（常常是DELETE或Ctrl - C）或退出键（常常是Ctrl - \），<strong>内核就会将中断信号或退出信号送至前台进程组的所有进程。</strong><ul>
<li><strong>只有在前台进程组中进程才能在控制终端读取输入</strong>。当用户在终端输入信号生成终端字符（如 ctrl+c、ctrl+z、ctr+\等）时，内核会把对应的信号发送给前台进程组。前台进程组的输出也会显示在控制终端上。</li>
</ul>
</li>
</ul>
<h4 id="用-bin-kill程序发送信号"><a href="#用-bin-kill程序发送信号" class="headerlink" title="用/bin/kill程序发送信号"></a>用/bin/kill程序发送信号</h4><ul>
<li>/bin/kill program    sends    arbitrary    signal    to    a    process or process    group</li>
<li><strong>send a signal to a process</strong> 不是杀掉一个process!</li>
<li>DESCRIPTION<ul>
<li>The  default signal for kill is TERM.  Use -l or -L to list available signals.  </li>
<li><strong>Particularly useful signals include HUP, INT, KILL, STOP, CONT, and 0.</strong>  </li>
<li><strong>Alternate signals may be specified in three ways: -9, -SIGKILL or -KILL</strong>.  </li>
<li>Negative PID values may be used to choose whole process groups<ul>
<li>A PID of -1 is special; it indicates all processes except the kill process itself and init.</li>
</ul>
</li>
</ul>
</li>
<li>Examples    <ul>
<li>/bin/kill –9 24818 ：Send    SIGKILL    to    process    24818    </li>
<li>/bin/kill –9 –24817 ：Send    SIGKILL    to    every    process    in    process    group    24817</li>
</ul>
</li>
</ul>
<h4 id="用kill函数发送信号"><a href="#用kill函数发送信号" class="headerlink" title="用kill函数发送信号"></a>用kill函数发送信号</h4><ul>
<li>pid&gt;0，kill函数发送信号sig给pid</li>
<li>pid=0，kill发送sig给调用进程所在进程组的每个进程</li>
<li>pid&lt;0，kill发送给进程组|pid|中的每个进程。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kill</span><span class="params">(<span class="keyword">pid_t</span> pid,<span class="keyword">int</span> sig)</span></span>;</span><br><span class="line"><span class="keyword">return</span> val  </span><br><span class="line">  success : <span class="number">0</span></span><br><span class="line">  fail    : <span class="number">-1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="用alarm函数发送信号"><a href="#用alarm函数发送信号" class="headerlink" title="用alarm函数发送信号"></a>用alarm函数发送信号</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">alarm</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> secs)</span></span>;</span><br><span class="line"><span class="keyword">return</span> val:</span><br><span class="line">  前一次闹钟剩余的秒数，若以前没有设定闹钟，则为<span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>alarm函数：安排内核在secs秒后发送一个SIGALRM信号给调用进程。<ul>
<li>secs=0，则不会调度安排新的alarm</li>
</ul>
</li>
</ul>
<h3 id="接收信号-1"><a href="#接收信号-1" class="headerlink" title="接收信号"></a>接收信号</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><ul>
<li>内核把进程p从内核模式切换到用户模式时（例如，从系统调用返回或完成了一次上下文切换），它会检查进程p的**未被阻塞的待处理信号的集合(pending &amp; ~blocked)**。<ul>
<li><strong>若集合为空</strong>：内核将控制传递到p的逻辑控制流的下一条指令（I_next）</li>
<li><strong>若集合非空</strong>：内核选择集合中的某个信号k（通常是最小的k），并强制p接收信号k。进程反应安慰你之后，控制就传递回p的逻辑控制流中的下一条指令（I_next）<ul>
<li><strong>信号对应的默认行为</strong>（信号处理程序默认做什么）<ul>
<li>The    process    terminates</li>
<li>The    process    terminates    and    dumps    core(转储内存)</li>
<li>The    process    stops    until    restarted    by    a    SIGCONT signal</li>
<li>The    process    ignores    the    signal</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>SIGSTOP 和 SIGKILL的默认行为不能更改</li>
</ul>
<h4 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h4><ul>
<li><p>signal</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="keyword">sighandler_t</span>)</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">sighandler_t</span> <span class="title">signal</span><span class="params">(<span class="keyword">int</span> signum,<span class="keyword">sighandler_t</span> handler)</span></span>;</span><br><span class="line"><span class="keyword">return</span> :</span><br><span class="line">  success ：返回指向前次处理程序的指针</span><br><span class="line">  error：SIG_ERR 且 不设置errno</span><br></pre></td></tr></table></figure>
<ul>
<li>handler = SIG_IGN ，那么忽略signum型信号</li>
<li>handler = SIG_DFL，那么signum的信号行为恢复为默认行为</li>
<li>Otherwise,    handler    is    the    address    of    a    user-level    signal    handler。调用信号处理程序称为捕获信号，执行信号处理程序称为处理信号。<ul>
<li> Called    when    process    receives    signal    of    type    signum</li>
<li> Executing    handler    is    called    “catching”    or    “handling”    the    signal</li>
<li> return时控制传递给被中断的指令：When    the    handler    executes    its    return    statement,    control    passes    back    to    instruction    in    the    control    flow    of    the    process    that    was    interrupted    by receipt    of    the    signal</li>
</ul>
</li>
</ul>
</li>
<li><p><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-20-04-31.png"></p>
</li>
<li><p><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-20-09-06.png"><br><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-11-20-09-18.png"></p>
</li>
</ul>
<h4 id="SIGCHLD信号处理"><a href="#SIGCHLD信号处理" class="headerlink" title="SIGCHLD信号处理"></a>SIGCHLD信号处理</h4><p><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-13-52-44.png"><br><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-13-50-02.png"></p>
<ul>
<li>如何利用SIGCHLD 非阻塞 回收子进程 </li>
<li>下面这段代码不见得对</li>
<li>handler里面的waitpid的返回值究竟应该和0比较还是和-1比较，目前来看，我认为 如果！=-1的判断条件的话，那么while会一直轮询下去，很消耗性能，甚至还不如阻塞等待wait(null)。我认为应当是和0比较，如果&gt;0，就轮询,==0或者=-1就不轮询了。<ul>
<li>WNOHANG =-1是error ，=0是集合里剩余的所有进程还没结束</li>
<li>默认（HANG）=-1 &amp;&amp; errno = echild是 所有进程都被回收完毕。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  回收子进程比较好的方案，一定要会！！： 利用信号机制去回收子进程，防止使用execlp而无法回收子线程的情况</span></span><br><span class="line"><span class="comment">//  利用的信号：SIGCHLD</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">catch</span><span class="params">(<span class="keyword">int</span> signo)</span>   </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> wpid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="comment">// while((wpid=wait(&amp;status)))</span></span><br><span class="line">    <span class="comment">// while((wpid=waitpid(-1,&amp;status,0)!=-1))</span></span><br><span class="line">    <span class="keyword">while</span>((wpid=waitpid(<span class="number">-1</span>,&amp;status,WNOHANG))!=<span class="number">-1</span>)   </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(wpid==<span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span>(WIFEXITED(status))</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;child %d exit with %d\n&quot;</span>,wpid,WEXITSTATUS(status));</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(WIFSIGNALED(status))</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;child %d killed with %d\n&quot;</span>,wpid,WTERMSIG(status));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( ;i&lt;<span class="number">10</span>;++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((pid=fork())==<span class="number">0</span>) </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//  设置PCB中的mask屏蔽字屏蔽SIGCHLD</span></span><br><span class="line">    <span class="keyword">sigset_t</span> <span class="built_in">set</span>;</span><br><span class="line">    sigemptyset(&amp;<span class="built_in">set</span>);</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>,SIGCHLD);</span><br><span class="line">    sigprocmask(SIG_BLOCK,&amp;<span class="built_in">set</span>,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i==<span class="number">10</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">//  在进行主函数逻辑之前</span></span><br><span class="line">        <span class="comment">//  注册信号处理函数 来 处理捕捉信号</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//  准备act</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">        act.sa_handler = <span class="keyword">catch</span>;    </span><br><span class="line">        act.sa_flags = <span class="number">0</span>;  </span><br><span class="line">        sigemptyset(&amp;act.sa_mask); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//注册捕捉信号的处理函数  </span></span><br><span class="line">        sigaction(SIGCHLD,&amp;act,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解除屏蔽</span></span><br><span class="line">        sigprocmask(SIG_UNBLOCK,&amp;<span class="built_in">set</span>,<span class="literal">NULL</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//  模拟后序逻辑</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>);      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;i am child id = %d\n&quot;</span>,getpid());</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shc@shc-<span class="keyword">virtual</span>-machine:~/code/revier/src$ ./signal_to_catch_child.out </span><br><span class="line">i am child id = <span class="number">8585</span></span><br><span class="line">i am child id = <span class="number">8586</span></span><br><span class="line">i am child id = <span class="number">8589</span></span><br><span class="line">i am child id = <span class="number">8588</span></span><br><span class="line">i am child id = <span class="number">8587</span></span><br><span class="line">i am child id = <span class="number">8590</span></span><br><span class="line">i am child id = <span class="number">8593</span></span><br><span class="line">i am child id = <span class="number">8591</span></span><br><span class="line">i am child id = <span class="number">8594</span></span><br><span class="line">i am child id = <span class="number">8592</span></span><br><span class="line">child <span class="number">8585</span> <span class="built_in">exit</span> with <span class="number">0</span></span><br><span class="line">child <span class="number">8586</span> <span class="built_in">exit</span> with <span class="number">1</span></span><br><span class="line">child <span class="number">8587</span> <span class="built_in">exit</span> with <span class="number">2</span></span><br><span class="line">child <span class="number">8588</span> <span class="built_in">exit</span> with <span class="number">3</span></span><br><span class="line">child <span class="number">8589</span> <span class="built_in">exit</span> with <span class="number">4</span></span><br><span class="line">child <span class="number">8590</span> <span class="built_in">exit</span> with <span class="number">5</span></span><br><span class="line">child <span class="number">8591</span> <span class="built_in">exit</span> with <span class="number">6</span></span><br><span class="line">child <span class="number">8592</span> <span class="built_in">exit</span> with <span class="number">7</span></span><br><span class="line">child <span class="number">8593</span> <span class="built_in">exit</span> with <span class="number">8</span></span><br><span class="line">child <span class="number">8594</span> <span class="built_in">exit</span> with <span class="number">9</span></span><br><span class="line">^C</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<ul>
<li>忽略了SIGCHLD信号之后，子进程不必再手动wait回收获取信息，也没有残余资源。所以，如果不需要子进程的信息的话，应该直接忽略SIGCHLD信号。</li>
<li>如果要忽略SIGCHLD信号，需直接写出signal(SIGCHLD,SIG_IGN)<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">if</span>((pid=fork())==<span class="number">0</span>)&#123;</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;my child is %d\n&quot;</span>,pid);</span><br><span class="line"></span><br><span class="line">    signal(SIGCHLD,SIG_IGN);    <span class="comment">//  忽略 SIGCHLD</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pid_t</span> child = waitpid(pid,&amp;status,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(child == <span class="number">-1</span> &amp;&amp; errno == ECHILD)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SIGCHLD is connected with waitpid\n&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(WIFEXITED(status))&#123;                  <span class="comment">//  true  &lt;---&gt;  child process return  /  exit</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;child %d terminated normally with exit status %d\n&quot;</span>,child,WEXITSTATUS(status));    <span class="comment">//  return the exist status of a normally exit process       </span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;child %d terminated abnormally\n&quot;</span>,child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shc@shc-<span class="keyword">virtual</span>-machine:~/code/csapp_try/process$ ./sigchld_wait </span><br><span class="line">my child is <span class="number">125233</span></span><br><span class="line">SIGCHLD is connected with waitpid</span><br><span class="line"></span><br><span class="line">$ ps ajx</span><br><span class="line"><span class="number">123968</span> <span class="number">124077</span> <span class="number">124077</span> <span class="number">124077</span> pts/<span class="number">9</span>    <span class="number">125232</span> Ss    <span class="number">1000</span>   <span class="number">0</span>:<span class="number">00</span> /bin/bash</span><br><span class="line"><span class="number">123754</span> <span class="number">125153</span> <span class="number">123754</span> <span class="number">123754</span> ?            <span class="number">-1</span> S     <span class="number">1000</span>   <span class="number">0</span>:<span class="number">00</span> sleep <span class="number">180</span></span><br><span class="line"><span class="number">124077</span> <span class="number">125232</span> <span class="number">125232</span> <span class="number">124077</span> pts/<span class="number">9</span>    <span class="number">125232</span> S+    <span class="number">1000</span>   <span class="number">0</span>:<span class="number">00</span> ./sigchld_wait</span><br><span class="line"><span class="number">125232</span> <span class="number">125233</span> <span class="number">125232</span> <span class="number">124077</span> pts/<span class="number">9</span>    <span class="number">125232</span> S+    <span class="number">1000</span>   <span class="number">0</span>:<span class="number">00</span> ./sigchld_wait</span><br><span class="line"><span class="number">116918</span> <span class="number">125255</span> <span class="number">125255</span> <span class="number">116918</span> pts/<span class="number">1</span>    <span class="number">125255</span> R+    <span class="number">1000</span>   <span class="number">0</span>:<span class="number">00</span> ps ajx</span><br><span class="line"></span><br><span class="line">shc@shc-<span class="keyword">virtual</span>-machine:~/code/csapp_try/process$ ps ajx</span><br><span class="line">  PPID    PID   PGID    SID TTY       TPGID STAT   UID   TIME COMMAND</span><br><span class="line">    <span class="number">0</span>      <span class="number">1</span>      <span class="number">1</span>      <span class="number">1</span> ?            <span class="number">-1</span> Ss       <span class="number">0</span>   <span class="number">1</span>:<span class="number">17</span> /sbin/init splash</span><br><span class="line"><span class="number">123754</span> <span class="number">125153</span> <span class="number">123754</span> <span class="number">123754</span> ?            <span class="number">-1</span> S     <span class="number">1000</span>   <span class="number">0</span>:<span class="number">00</span> sleep <span class="number">180</span></span><br><span class="line"><span class="number">124077</span> <span class="number">125232</span> <span class="number">125232</span> <span class="number">124077</span> pts/<span class="number">9</span>    <span class="number">125232</span> S+    <span class="number">1000</span>   <span class="number">0</span>:<span class="number">00</span> ./sigchld_wait</span><br><span class="line"><span class="number">116918</span> <span class="number">125267</span> <span class="number">125267</span> <span class="number">116918</span> pts/<span class="number">1</span>    <span class="number">125267</span> R+    <span class="number">1000</span>   <span class="number">0</span>:<span class="number">00</span> ps ajx</span><br></pre></td></tr></table></figure></li>
</ul>
<p>waitpid函数里面是怎么实现的呀？我觉得是先判断有没有已经死去的子进程，没有则阻塞，再等待SIGCHLD信号触发SIGCHLD的信号处理程序，处理信号 获取进程信息？</p>
<h3 id="wait-a-signal-to-be-caught-等待（任意）一个信号"><a href="#wait-a-signal-to-be-caught-等待（任意）一个信号" class="headerlink" title="wait a signal to be caught 等待（任意）一个信号"></a>wait a signal to be caught 等待（任意）一个信号</h3><ul>
<li>Waiting for a signal to be caught<ul>
<li>The following system calls suspend execution of the calling process or thread until a signal is caught (or an unhandled signal terminates the process):</li>
<li><strong>pause</strong>(2)        Suspends execution until any signal is caught.</li>
<li><strong>sigsuspend</strong>(2)   Temporarily changes the signal mask (see below) and suspends execution until one of the unmasked signals is caught.</li>
</ul>
</li>
</ul>
<h3 id="Signal-mask-and-pending-signals"><a href="#Signal-mask-and-pending-signals" class="headerlink" title="Signal mask and pending signals"></a>Signal mask and pending signals</h3><ul>
<li>Signal mask and pending signals<ul>
<li><strong>Blocked阻塞</strong> : A signal may be <strong>blocked</strong>, which means that it will <strong>not be delivered</strong> until it is later unblocked.  <ul>
<li>not be delivered – 没有递送到 — 没被process处理</li>
</ul>
</li>
<li><strong>pending 没处理</strong> : Between the time when it is generated and when it is delivered a  signal is said to be <strong>pending</strong>.</li>
<li>**signal mask ** : Each  thread  in  a process has an independent <strong>signal mask</strong>, which indicates the set of signals that the thread is <strong>currently blocking</strong>.<ul>
<li>signal mask 就是当前的 block set  </li>
<li><strong>sigprocmask</strong> : A thread can manipulate its signal mask using pthread_sigmask(3).  In a traditional single-threaded application, <strong>sigprocmask</strong>(2) can be used to manipulate the signal mask.</li>
<li><strong>fork and signal mask</strong> : A child created via fork(2) <strong>inherits a copy of its parent’s signal mask</strong>; the signal mask is preserved across execve(2).</li>
</ul>
</li>
<li><strong>which to deliver signal</strong> : A signal may be generated (and thus pending) for a process as a whole (e.g., when sent using kill(2)) or for a specific thread (e.g., certain signals,  such  as  SIGSEGV and  SIGFPE,  generated  as  a  consequence  of executing a specific machine-language instruction are thread directed, as are signals targeted at a specific thread using pthread_kill(3)).  A process-directed signal may be delivered to <strong>any one of</strong> the threads that <strong>does not currently have the signal blocked</strong>.  If more than one of the threads has the signal unblocked, then the kernel chooses an arbitrary thread to which to deliver the signal.</li>
<li>A thread can obtain the set of signals that it currently has pending using sigpending(2).  This set will consist of the union of the set of pending process-directed signals and the set of signals pending for the calling thread.</li>
<li><strong>fork and pending set</strong> : A child created via fork(2) initially has an <strong>empty pending signal set</strong>; the pending signal set is preserved across an execve(2).</li>
</ul>
</li>
</ul>
<h3 id="阻塞、解除阻塞-sigprocmask"><a href="#阻塞、解除阻塞-sigprocmask" class="headerlink" title="阻塞、解除阻塞 sigprocmask"></a>阻塞、解除阻塞 sigprocmask</h3><ul>
<li><strong>sigprocmask DESCRIPTION</strong><ul>
<li>sigprocmask()  is  used  to fetch and/or change the <strong>signal mask</strong> of the calling thread.  </li>
<li>The <strong>signal mask</strong> is the set of signals whose delivery is <strong>currently blocked for the caller</strong> (see also signal(7) for more details).</li>
<li>The behavior of the call is dependent on the value of how, as follows.</li>
</ul>
</li>
</ul>
<ul>
<li><p>隐式阻塞：<strong>内核默认阻塞任何当前处理程序正在处理信号类型的待处理的信号。</strong></p>
<ul>
<li>eg:    A    SIGINT    handler    can’t    be    interrupted    by    another    SIGINT</li>
</ul>
</li>
<li><p>显示阻塞：<strong>sigprocmask</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigprocmask</span><span class="params">(<span class="keyword">int</span> how,<span class="keyword">const</span> <span class="keyword">sigset_t</span> *<span class="built_in">set</span>,sigset *oldset)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigemptyset</span><span class="params">(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>)</span></span>;     </span><br><span class="line">  <span class="comment">//  create empty set</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigfillset</span><span class="params">(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>)</span></span>;</span><br><span class="line">  <span class="comment">//  add every signal number to set </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigaddset</span><span class="params">(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>,<span class="keyword">int</span> signum)</span></span>;</span><br><span class="line">  <span class="comment">//  add signal number to set</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigdelset</span><span class="params">(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>,<span class="keyword">int</span> signum)</span></span>;</span><br><span class="line">  <span class="comment">//  delete signal number from set</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigismember</span><span class="params">(<span class="keyword">const</span> <span class="keyword">sigset_t</span> *<span class="built_in">set</span>,<span class="keyword">int</span> signum)</span></span>;</span><br></pre></td></tr></table></figure></li>
<li><p>int sigprocmask(int how,const sigset_t *set,sigset *oldset);</p>
<ul>
<li>改变当前阻塞的信号集合</li>
<li>how = SIG_BLOCK：blocked = blocked | set</li>
<li>how = SIG_UNBLOCK：blocked = blocked &amp; (~set)</li>
<li>how = SIG_SETMASK：blockded = set</li>
<li>oldset = prev_mask;</li>
</ul>
</li>
<li><p>例子：如何阻塞SIGINT信号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sigset_t</span> mask,prev_mask;</span><br><span class="line"></span><br><span class="line">sigemptyset(&amp;mask);       <span class="comment">//  mask = null</span></span><br><span class="line">sigaddset(&amp;mask,SIGINT);  <span class="comment">//  mask = mask | SIGINT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  blocked sigint and save previous blocked set</span></span><br><span class="line">sigprocmask(SIG_BLOCK,&amp;mask,&amp;prev_mask);</span><br><span class="line"><span class="comment">//...  Code region that will not be interrupted by SIGINT</span></span><br><span class="line"><span class="comment">//  **restore previous blocked set , unblocking SIGINT**</span></span><br><span class="line">sigprocmask(SIG_SETMASK,&amp;prev_mask,<span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Safe-Signal-Handling-信号处理程序注意"><a href="#Safe-Signal-Handling-信号处理程序注意" class="headerlink" title="Safe    Signal    Handling 信号处理程序注意"></a>Safe    Signal    Handling 信号处理程序注意</h3><ul>
<li>棘手<ul>
<li>signal handler 和 main program concurrently 运行，sharing data structures 共享全局变量，可能互相干扰</li>
<li>如何以及何时接收信号</li>
<li>不通过的系统有不同的信号处理语义</li>
</ul>
</li>
</ul>
<h4 id="Guidlines-for-Writing-Safe-Handlers-CSAPP-P534"><a href="#Guidlines-for-Writing-Safe-Handlers-CSAPP-P534" class="headerlink" title="Guidlines for Writing Safe Handlers CSAPP P534"></a>Guidlines for Writing Safe Handlers CSAPP P534</h4><ul>
<li><p><strong>G0:    Keep    your    handlers    as    simple    as    possible</strong>    </p>
<ul>
<li>e.g.,    Set    a    global    flag    and    return    </li>
</ul>
</li>
<li><p><strong>G1:    Call    only    async-signal-safe    functions    in    your    handlers</strong>    </p>
<ul>
<li>printf, sprintf, malloc,    and    exit    are    not    safe!</li>
<li>write is safe    </li>
</ul>
</li>
<li><p><strong>G2:    Save    and    restore    errno    on    entry    and    exit</strong></p>
<ul>
<li>So    that    other    handlers    don’t    overwrite    your    value    of    errno</li>
</ul>
</li>
<li><p><strong>G3:    Protect    accesses    to    shared    data    structures    by temporarily    blocking    all    signals</strong>.        </p>
<ul>
<li>To    prevent    possible    corruption<ul>
<li>从主程序访问一个data structure 需要一系列指令，如果指令序列被访问d的处理程序中断，那么前后d的状态不一致，可能会导致不可预知的结果    </li>
</ul>
</li>
</ul>
</li>
<li><p><strong>G4:</strong>    Declare    global    variables    as    <strong>volatile</strong> </p>
<ul>
<li><strong>To    prevent    compiler    from    storing    them    in    a    register</strong></li>
</ul>
</li>
<li><p><strong>G5:    Declare    global    flags    as    volatile sig_atomic_t</strong></p>
<ul>
<li>flag:    variable    that    is    only    read    or    wriien    not incremented or updated(e.g.    flag    =    1,    not    flag++)    </li>
<li>if we do that then teh system guarantees that reads and writen to that variable will be atmoic</li>
<li>So if Flag    declared    this    way    does    not    need    to    be    protected        like    other    globals</li>
</ul>
</li>
<li><p><strong>不可以用信号来对其他进程中发生的事件计数。</strong></p>
</li>
</ul>
<h4 id="Async-Signal-Safety-异步信号安全"><a href="#Async-Signal-Safety-异步信号安全" class="headerlink" title="Async-Signal-Safety 异步信号安全"></a>Async-Signal-Safety 异步信号安全</h4><ul>
<li>function : <strong>async signal safety 异步信号安全</strong><ul>
<li>printf就不是异步信号安全的，printf获得一个terminal的锁。</li>
<li>如下，main和handler里面都调用print，造成了deadlock<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span>&#123;  <span class="comment">//  handler INT</span></span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="comment">//  lock aquire ? </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hi\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="comment">//  terminal lock   </span></span><br><span class="line">    printd(<span class="string">&quot;hello\n&quot;</span>);        <span class="comment">//  被信号打断，进入handler。handler里的printf还想获得锁，但是显然不可。死锁等待。</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">write是异步信号安全的</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Function    is    async-signal-safe    if    either    reentrant    (e.g.,    all    variables    stored    on    stack    frame,    CS:APP3e    12.7.2)    or    non-interruptible    by    signals.    </li>
<li>Posix    guarantees    117    functions    to    be    async-signal-safe    <ul>
<li>Source:    “man 7 signal”    </li>
<li>Popular    functions    on    the    list:    <ul>
<li>_exit, write, wait, waitpid, sleep, kill </li>
</ul>
</li>
<li>Popular    functions    that    are    not    on    the    list:    <ul>
<li>printf,        sprintf, malloc, exit </li>
<li>Unfortunate    fact:    write    is    the    only    async-signal-safe    output    function</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Portable-Signal-Handling"><a href="#Portable-Signal-Handling" class="headerlink" title="Portable    Signal    Handling"></a>Portable    Signal    Handling</h4><ul>
<li>Ugh!    Different    versions    of    Unix    can    have    different    signal    handling    semantics<ul>
<li>Some    older    systems    restore    action    to    default    after    catching    signal    </li>
<li>Some    interrupted    system    calls    can    return    with    errno    ==    EINTR    (慢速系统调用被中断)</li>
<li>Some    systems    don’t    block    signals    of    the    type    being    handled    </li>
</ul>
</li>
<li> Solution:    sigaction<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">typedef</span> <span class="keyword">void</span> <span class="title">handler_t</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="number">151</span> <span class="comment">/* $begin sigaction */</span></span><br><span class="line"><span class="number">152</span> <span class="function"><span class="keyword">handler_t</span> *<span class="title">Signal</span><span class="params">(<span class="keyword">int</span> signum, <span class="keyword">handler_t</span> *handler)</span></span></span><br><span class="line"><span class="function">153 </span>&#123;</span><br><span class="line"><span class="number">154</span>     <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">action</span>, <span class="title">old_action</span>;</span></span><br><span class="line"><span class="number">155</span> </span><br><span class="line"><span class="number">156</span>     action.sa_handler = handler;  <span class="comment">//  指明处理函数  </span></span><br><span class="line"><span class="number">157</span>     sigemptyset(&amp;action.sa_mask); <span class="comment">/* Block sigs of type being handled */</span>  <span class="comment">//  解决有的系统不block正在被处理的信号</span></span><br><span class="line"><span class="number">158</span>     action.sa_flags = SA_RESTART; <span class="comment">/* Restart syscalls if possible */</span>  <span class="comment">//  解决慢速系统调用被中断</span></span><br><span class="line"><span class="number">159</span> </span><br><span class="line"><span class="number">160</span>     <span class="keyword">if</span> (sigaction(signum, &amp;action, &amp;old_action) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">161</span>         unix_error(<span class="string">&quot;Signal error&quot;</span>);</span><br><span class="line"><span class="number">162</span>     <span class="keyword">return</span> (old_action.sa_handler);</span><br><span class="line"><span class="number">163</span> &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="Synchronizing-Flow-to-Avoid-Races"><a href="#Synchronizing-Flow-to-Avoid-Races" class="headerlink" title="Synchronizing Flow to Avoid Races"></a>Synchronizing Flow to Avoid Races</h4><ul>
<li><p><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-14-37-43.png"></p>
</li>
<li><p><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-14-38-08.png"></p>
</li>
<li><p><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-14-49-31.png"></p>
</li>
</ul>
<h4 id="Explicitly-Waiting-for-Signals"><a href="#Explicitly-Waiting-for-Signals" class="headerlink" title="Explicitly    Waiting    for    Signals"></a>Explicitly    Waiting    for    Signals</h4><ul>
<li><p>Handlers    for    program    explicitly    waiting    for    SIGCHLD    to    arrive</p>
<ul>
<li><strong>while(!pid)</strong> 通过共享的全局变量global</li>
<li><strong>correct! but wasteful!</strong><br><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-15-11-50.png"><br><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-15-12-03.png"></li>
</ul>
</li>
<li><p>Other    options:</p>
<ul>
<li>RACE！不可这样，可能导致一直卡在pause();    <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(!pid)</span><br><span class="line">  <span class="comment">//  如果在这里 接收了信号 hanlder处理了signal 改变了pid</span></span><br><span class="line">  <span class="comment">//  但是之后pause不会再被唤醒 因为没信号了。</span></span><br><span class="line">  pause();</span><br></pre></td></tr></table></figure></li>
<li>TOO SLOW！<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(!pid)</span><br><span class="line">  sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Solution : sigsuspend</p>
</li>
</ul>
<h4 id="Waiting-for-Signals-with-sigsuspend"><a href="#Waiting-for-Signals-with-sigsuspend" class="headerlink" title="Waiting    for    Signals    with    sigsuspend"></a>Waiting    for    Signals    with    sigsuspend</h4><ul>
<li>sigsuspend：等待任意一个信号到来<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigsuspend</span><span class="params">(<span class="keyword">const</span> <span class="keyword">sigset_t</span> *mask)</span></span>;</span><br></pre></td></tr></table></figure>
<img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-15-33-49.png"><ul>
<li>DESCRIPTION<ul>
<li>sigsuspend()  temporarily  <strong>replaces</strong>  the  signal  mask  of the calling process with the mask given by mask and then <strong>suspends</strong> the process <strong>until delivery of a signal</strong> whose action is to invoke a signal handler or to terminate a process.</li>
<li>If the signal terminates the process, then sigsuspend() does not return.  If the signal is caught, then sigsuspend() returns after the signal handler  returns,  and  the signal mask is restored to the state before the call to sigsuspend().</li>
<li>It is not possible to block SIGKILL or SIGSTOP; specifying these signals in mask, has no effect on the process’s signal mask.</li>
</ul>
</li>
</ul>
</li>
<li>在不消耗性能的情况下，实现Explicitly    Waiting    for    Signal<br><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-20-15-38-34.png"></li>
</ul>
<h3 id="小结-内核让进程p接收信号流程"><a href="#小结-内核让进程p接收信号流程" class="headerlink" title="小结 内核让进程p接收信号流程"></a>小结 内核让进程p接收信号流程</h3><ul>
<li><p>内核为每个进程p维护两个向量</p>
<ul>
<li>一个是 pending   —-  待处理信号的集合 </li>
<li>另一个是 blocked —-  当前阻塞的信号集合</li>
</ul>
</li>
<li><p>未被阻塞的待处理信号的集合：pending &amp; ~blocked（进程p需要接收的信号）</p>
</li>
<li><p>何时会有内核检查p的pending &amp; ~blocked的契机</p>
<ul>
<li>内核把进程p从内核切换到用户模式</li>
</ul>
</li>
</ul>
<ul>
<li>一个signal发送给进程p时<ul>
<li>p先将该信号加入pending向量中 因为仅仅是向量，所以并不支持排队</li>
<li>然后看该信号是否被blocked（blocked集合中该信号是否置为1<ul>
<li>被blocked，则进程p不进行相应的signal handler。pending中保持该signal为1，直到相应signal handler被调用。<ul>
<li>当该signal不再被blocked时，pending中该signal又为1，故p会接收该signal（触发相应handler）</li>
</ul>
</li>
<li>没被blocked，则进程p触发相应的signal handler。pending中该signal归0，blocked向量中加入该信号，直到相应的signal handler执行完毕，blocked向量中移除该信号。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="CSAPP-540-546"><a href="#CSAPP-540-546" class="headerlink" title="CSAPP 540-546"></a>CSAPP 540-546</h3><ul>
<li>同步流</li>
<li>显示竞争</li>
</ul>
<h2 id="Nonlocal-jump"><a href="#Nonlocal-jump" class="headerlink" title="Nonlocal    jump"></a>Nonlocal    jump</h2><ul>
<li>非本地跳转<strong>Nonlocal jump</strong><ul>
<li>用户级的异常控制流形式</li>
<li>通过<strong>setjmp,longjmp</strong></li>
<li>不需要经过正常的call-ret返回序列</li>
<li><strong>应用</strong>：<ul>
<li><ol>
<li>从一个深层嵌套的函数调用中立即返回，通常是由检测到某个错误情况引起的。可以直接返回到一个普通的错误处理程序，而非费力地解开调用栈，</li>
</ol>
</li>
<li><ol start="2">
<li>使得一个信号处理程序将控制传递到一个指定的代码位置，而非一定返回到被信号中断了的位置</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>C++中的catch  &lt;—&gt;  C中的setjmp</li>
<li>C++中的throw  &lt;—&gt;  C中的longjmp</li>
</ul>
<h3 id="setjmp"><a href="#setjmp" class="headerlink" title="setjmp"></a>setjmp</h3><ul>
<li><strong>int setjmp(jmp_buf env)</strong> <ul>
<li>功能：指明之后的longjmp返回的位置<ul>
<li>在env缓冲区保存当前调用环境：PC、stack pointer、通用目的寄存器。</li>
<li>必须在longjmp之前调用</li>
<li><strong>Called    once,    returns    one    or    more    times</strong></li>
<li>return 0</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="longjmp"><a href="#longjmp" class="headerlink" title="longjmp"></a>longjmp</h3><ul>
<li><strong>void longjmp(jmp_buf env,int retval)</strong><ul>
<li>功能：<strong>触发一个</strong> 从最近一次初始化env的 <strong>setjmp</strong> <strong>的返回</strong><ul>
<li>从env缓冲区中恢复调用环境，进而触发一个从最近一次初始化env的setjmp调用的返回，然后setjmp返回，并带有非0的返回值retval</li>
<li>在setjmp之后调用。</li>
<li><strong>called once , but never returns</strong></li>
<li>Set    %eax (the    return    value)    to    retval</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>应用2：软中断<br><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-12-18-38-49.png"></li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><img src="/2022/07/27/csapp-8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%812/2022-08-12-18-43-14.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Linux上进程的五种状态：</span><br><span class="line"></span><br><span class="line">1.R——Runnable（运行）：正在运行或在运行队列中等待</span><br><span class="line"></span><br><span class="line">2.S——sleeping（中断）：休眠中，受阻，在等待某个条件的形成或接收到信号</span><br><span class="line"></span><br><span class="line">3.D——uninterruptible sleep(不可中断)：收到信号不唤醒和不可运行，进程必须等待直到有中断发生</span><br><span class="line"></span><br><span class="line">4.Z——zombie（僵死）：进程已终止，但进程描述还在，直到父进程调用wait4()系统调用后释放</span><br><span class="line"></span><br><span class="line">5.T——traced or stoppd(停止)：进程收到SiGSTOP,SIGSTP,SIGTOU信号后停止运行</span><br><span class="line"></span><br><span class="line">状态后缀表示：</span><br><span class="line"></span><br><span class="line">&lt;：优先级高的进程</span><br><span class="line"></span><br><span class="line">N：优先级低的进程</span><br><span class="line"></span><br><span class="line">L：有些页被锁进内存</span><br><span class="line"></span><br><span class="line">s：进程的领导者（在它之下有子进程）</span><br><span class="line"></span><br><span class="line">l：ismulti-threaded (using CLONE_THREAD, like NPTL pthreads <span class="keyword">do</span>)</span><br><span class="line"></span><br><span class="line">+：位于后台的进程组</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CSAPP/" rel="tag"># CSAPP</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/07/25/csapp-9-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/" rel="prev" title="csapp-9-虚拟内存">
      <i class="fa fa-chevron-left"></i> csapp-9-虚拟内存
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/08/19/csapp-Shell-Lab/" rel="next" title="Shell-Lab">
      Shell-Lab <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Signal-%E4%BF%A1%E5%8F%B7"><span class="nav-number">1.</span> <span class="nav-text">Signal 信号</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E7%9A%84%E4%B8%A4%E4%B8%AA%E9%98%B6%E6%AE%B5"><span class="nav-number">1.1.</span> <span class="nav-text">信号的两个阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%A0%E9%80%81%E4%BF%A1%E5%8F%B7%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.2.</span> <span class="nav-text">传送信号的步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7"><span class="nav-number">1.2.1.</span> <span class="nav-text">发送信号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E4%BF%A1%E5%8F%B7"><span class="nav-number">1.2.2.</span> <span class="nav-text">接收信号</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#send-signal-%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7"><span class="nav-number">1.3.</span> <span class="nav-text">send signal 发送信号</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%84-amp-%E4%BC%9A%E8%AF%9Dsession"><span class="nav-number">1.3.1.</span> <span class="nav-text">进程组 &amp; 会话session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8E%E9%94%AE%E7%9B%98%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7"><span class="nav-number">1.3.2.</span> <span class="nav-text">从键盘发送信号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8-bin-kill%E7%A8%8B%E5%BA%8F%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7"><span class="nav-number">1.3.3.</span> <span class="nav-text">用&#x2F;bin&#x2F;kill程序发送信号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8kill%E5%87%BD%E6%95%B0%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7"><span class="nav-number">1.3.4.</span> <span class="nav-text">用kill函数发送信号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8alarm%E5%87%BD%E6%95%B0%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7"><span class="nav-number">1.3.5.</span> <span class="nav-text">用alarm函数发送信号</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E4%BF%A1%E5%8F%B7-1"><span class="nav-number">1.4.</span> <span class="nav-text">接收信号</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.4.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#signal"><span class="nav-number">1.4.2.</span> <span class="nav-text">signal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SIGCHLD%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86"><span class="nav-number">1.4.3.</span> <span class="nav-text">SIGCHLD信号处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wait-a-signal-to-be-caught-%E7%AD%89%E5%BE%85%EF%BC%88%E4%BB%BB%E6%84%8F%EF%BC%89%E4%B8%80%E4%B8%AA%E4%BF%A1%E5%8F%B7"><span class="nav-number">1.5.</span> <span class="nav-text">wait a signal to be caught 等待（任意）一个信号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Signal-mask-and-pending-signals"><span class="nav-number">1.6.</span> <span class="nav-text">Signal mask and pending signals</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%BB%E5%A1%9E%E3%80%81%E8%A7%A3%E9%99%A4%E9%98%BB%E5%A1%9E-sigprocmask"><span class="nav-number">1.7.</span> <span class="nav-text">阻塞、解除阻塞 sigprocmask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Safe-Signal-Handling-%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E6%B3%A8%E6%84%8F"><span class="nav-number">1.8.</span> <span class="nav-text">Safe    Signal    Handling 信号处理程序注意</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Guidlines-for-Writing-Safe-Handlers-CSAPP-P534"><span class="nav-number">1.8.1.</span> <span class="nav-text">Guidlines for Writing Safe Handlers CSAPP P534</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Async-Signal-Safety-%E5%BC%82%E6%AD%A5%E4%BF%A1%E5%8F%B7%E5%AE%89%E5%85%A8"><span class="nav-number">1.8.2.</span> <span class="nav-text">Async-Signal-Safety 异步信号安全</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Portable-Signal-Handling"><span class="nav-number">1.8.3.</span> <span class="nav-text">Portable    Signal    Handling</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Synchronizing-Flow-to-Avoid-Races"><span class="nav-number">1.8.4.</span> <span class="nav-text">Synchronizing Flow to Avoid Races</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Explicitly-Waiting-for-Signals"><span class="nav-number">1.8.5.</span> <span class="nav-text">Explicitly    Waiting    for    Signals</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Waiting-for-Signals-with-sigsuspend"><span class="nav-number">1.8.6.</span> <span class="nav-text">Waiting    for    Signals    with    sigsuspend</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-%E5%86%85%E6%A0%B8%E8%AE%A9%E8%BF%9B%E7%A8%8Bp%E6%8E%A5%E6%94%B6%E4%BF%A1%E5%8F%B7%E6%B5%81%E7%A8%8B"><span class="nav-number">1.9.</span> <span class="nav-text">小结 内核让进程p接收信号流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSAPP-540-546"><span class="nav-number">1.10.</span> <span class="nav-text">CSAPP 540-546</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nonlocal-jump"><span class="nav-number">2.</span> <span class="nav-text">Nonlocal    jump</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#setjmp"><span class="nav-number">2.1.</span> <span class="nav-text">setjmp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#longjmp"><span class="nav-number">2.2.</span> <span class="nav-text">longjmp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">小结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Cstardust</p>
  <div class="site-description" itemprop="description">知不可乎骤得,托遗响于悲风</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">87</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cstardust</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">622k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">9:25</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'd683461326668b112a07',
      clientSecret: 'fbd3f91ac2d4f7b501c4b5f88af770661529c238',
      repo        : 'BlogComments',
      owner       : 'Cstardust',
      admin       : ['Cstardust'],
      id          : '4041fff52684d74d79becdec7b508b5d',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
